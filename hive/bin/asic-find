#!/bin/bash
##!/hive/sbin/bash

. asic-model

function value() {
	echo out > /sys/class/gpio/gpio$GPIO_LED_RED/direction
	nohup /hive/sbin/bash -c "timeout -t $1 /hive/sbin/bash -c \
		'while true; do echo 1 > /sys/class/gpio/gpio${GPIO_LED_RED}/value; read -t 0.2; echo 0 > /sys/class/gpio/gpio${GPIO_LED_RED}/value; read -t 0.2; done';\
		echo 0 > /sys/class/gpio/gpio${GPIO_LED_RED}/value" &
}

function direction() {
	nohup /hive/sbin/bash -c "timeout -t $1 /hive/sbin/bash -c \
		'while true; do echo high > /sys/class/gpio/gpio${GPIO_LED_RED}/direction; read -t 0.2; echo low > /sys/class/gpio/gpio${GPIO_LED_RED}/direction; read -t 0.2; done';\
		echo low > /sys/class/gpio/gpio${GPIO_LED_RED}/direction" &
}

case $1 in
	stop)
		echo "kill"
	;;
	*)
		if [[ $1 =~ ^[0-9]+$ ]]; then
			echo "int"
			if [ ! -e /sys/class/gpio/gpio$GPIO_LED_RED ]; then
				echo $GPIO_LED_RED > /sys/class/gpio/export
			fi
			if [ $GPIO_PATH == "value" ]; then
				value
			elif [ $GPIO_PATH == "direction" ]; then
				direction
			fi
		else
			echo "Example: 'asic-find 15' for 15 minutes"
		fi
	;;
esac
