#!/usr/bin/env bash


readonly script_mission='Check for known viruses'
readonly script_version='0.1'


#
# strict mode, no unbound variables
#

set -o nounset


# consts

. colors


# vars

declare -i is_virus_found=0


# functions

print_script_version() {
	echo -e "${CYAN-}${script_mission}, version ${script_version}${NOCOLOR-}"
	echo
}


# code

print_script_version

message='ntpd integrity:'
if cksum /usr/bin/ntpd  | grep -q '892955227 358832 /usr/bin/ntpd'; then
	echo -e "$message ${BGREEN}ok${NOCOLOR}"
else
	echo -e "$message ${BRED}failed${NOCOLOR}"
	is_virus_found=1
fi

message='Antbuild check:'
if [ -e /etc/ld.so.preload -o -e /usr/bin/build -o -e /usr/bin/egrep ]; then
	# old1
	echo "$message ${BRED}v2 (uncured) found!${NOCOLOR}"
	is_virus_found=1
else
	if cksum /lib/modules/bitmain_axi.ko  | grep -q '1596665532 7415 /lib/modules/bitmain_axi.ko'; then
		# old2
		echo "$message ${BRED}v1 (cured) found!${NOCOLOR}"
		is_virus_found=1
	else
		if uname -r | grep -q "g16220c3"; then
			# new
			echo "$message ${BRED}v2 found!${NOCOLOR}"
			is_virus_found=1
		else
			echo "$message ${BGREEN}none found${NOCOLOR}"
		fi
	fi
fi

exit $(( is_virus_found ))
